name: Build and push

on: # yamllint disable-line rule:truthy
  workflow_dispatch: # manual trigger
    inputs:
      node_tag:
        description: 'Node tag'
        required: true
      node_image_tag:
        description: 'Node image tag'
        required: true

env:
  user: bisgardo
  node_image_repo: 'bisgardo/concordium-node'
  node_dashboard_image_repo: 'bisgardo/concordium-node-dashboard'
  node_tag: '${{ github.event.inputs.node_tag }}'
  node_image_tag: '${{ github.event.inputs.node_image_tag }}'
  node_dashboard_image_tag: 'node-${{ github.event.inputs.node_image_tag }}'

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Log in to Docker Hub
      run: docker login --username "${{ env.user }}" --password-stdin <<< "${{ secrets.DOCKERHUB_ACCESS_TOKEN }}"
    - name: Build and push Docker images
      working-directory: ./docker-compose
      run: |
        export NODE_TAG="${{ env.node_tag }}"
        export NODE_IMAGE="${{ env.node_image_repo }}:${{ env.node_image_tag }}"
        export NODE_DASHBOARD_IMAGE=${{ env.node_dashboard_image_repo }}:${{ env.node_dashboard_image_tag }}
        export COMPOSE_PROFILES=node-dashboard
        NODE_NAME= docker-compose build && docker-compose push
